<?php class Feeds_model extends CI_Model{	public function __construct()	{		$this->load->database();	}		public function get($limit=5, $page=1)	{		$query = "SELECT id, amen_count, like_count, 			message, user_amen_ids, user_like_ids, author,			picture, date_created, last_updated            FROM feeds ORDER BY 			last_updated DESC LIMIT $limit";		$result = $this->db->query($query);						return $result->result_array(); 	}        public function get_by_date($last_updated, $limit=5)     {        $query = "SELECT id, amen_count, like_count, 			message, user_amen_ids, user_like_ids, author,			picture, date_created, last_updated FROM feeds             WHERE last_updated < '$last_updated' LIMIT $limit";                $result = $this->db->query($query);        		return $result->result_array();     }		public function save($sns_type,		$author_sns_id, $author, $message, $picture,        $link, $caption, $description) 	{		if (!$sns_type) {			return false;		}				$query = "INSERT INTO feeds (sns_type, author_sns_id, 			author, message, picture, link, caption, description, date_created)			VALUES('$sns_type', '$author_sns_id', '$author', 			'$message', '$picture', '$link', '$caption', 			'$description', NOW())"; 				$this->db->query($query);        return mysql_insert_id();	}		public function amen($feed_id, $current_user_id)	{				$query = "SELECT user_amen_ids from feeds			WHERE id='$feed_id' LIMIT 1";					/*		$query = "UPDATE feeds SET amen_count=(amen_count+1),			user_amen_ids=(CASE when(user_amen_ids) then 			CONCAT(user_amen_ids, '$tmp') else			CONCAT(':', '$tmp') end) 			WHERE id='$feed_id'";		*/				$result = $this->db->query($query);		$result = $result->result_array(); 				if ($result[0]['user_amen_ids']) {			$new_amen_ids = $result[0]['user_amen_ids'].strval($current_user_id).':';			$query = "UPDATE feeds SET amen_count=(amen_count+1),				user_amen_ids='$new_amen_ids' WHERE id='$feed_id'";						}		else {			$new_amen_ids = ":".strval($current_user_id).":";			$query = "UPDATE feeds SET amen_count=(amen_count+1),				user_amen_ids='$new_amen_ids' WHERE id='$feed_id'";		}		return $this->db->query($query);		}		public function get_amens($feed_id)	{		$query = "SELECT user_amen_ids FROM feeds WHERE id='$feed_id'";		$result = $this->db->query($query);		return $result->result_array(); 	}		public function get_likes($feed_id)	{		$query = "SELECT user_like_ids FROM feeds WHERE id='$feed_id'";		$result = $this->db->query($query);		return $result->result_array(); 	}		public function is_amened($amens, $sns_id)	{		$tmp = ":$sns_id:";		if(strpos($amens, $tmp) !== false) {			return 1;		}		return 0;	}		public function is_liked($likes, $sns_id)	{		$tmp = ":$sns_id:";		if(strpos($likes, $tmp) !== false) {			return 1;		}		return 0;	}}