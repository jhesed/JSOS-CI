<?php class Praisewall_model extends CI_Model{	public function __construct()	{		$this->load->database();        $this->load->helper('cookie');	}		public function get($limit=5, $page=1)	{        if ($limit == '') {            $limit = 5;        }        		$query = "SELECT id, wall_title, amen_count, like_count, 			message, user_amen_ids, user_like_ids, author,			picture, date_created, last_updated            FROM praise_wall ORDER BY 			last_updated DESC LIMIT $limit";		$result = $this->db->query($query);						return $result->result_array(); 	}        public function get_by_date($praisewall_last_updated, $limit=5)     {        if ($limit == '') {            $limit = 5;        }        		if ($praisewall_last_updated != "REAPED_LAST") {                  if(!$praisewall_last_updated) {				$start = $this->config->item('wall_limit');				/* first scroll down */ 				$query = "SELECT a.* FROM ( SELECT id, wall_title, amen_count, like_count, message, user_amen_ids, user_like_ids, author,	picture, date_created, last_updated FROM praise_wall WHERE id > '$start' LIMIT $limit ) a ORDER BY a.id DESC";  			}						else {				$last_updated = $praisewall_last_updated;                        				$query = "SELECT id, wall_title, amen_count, like_count, 					message, user_amen_ids, user_like_ids, author,					picture, date_created, last_updated FROM praise_wall 					WHERE last_updated < '$last_updated' ORDER BY last_updated DESC LIMIT $limit" ;                // print $query;								}						$result = $this->db->query($query);        			$result_arr = $result->result_array(); 						// if($result_arr) {				// $this->input->set_cookie('praisewall_last_updated', $result_arr[count($result_arr)-1]['last_updated'], 86400);            // }			// else {	                // $this->input->set_cookie('praisewall_last_updated', 'REAPED_LAST', 86400);			// }            			return $result_arr;		}		else {			return "";		}    }		public function save($sns_type,		$author_sns_id, $author, $title, $message, $picture,        $link, $caption, $description) 	{		if (!$sns_type) {			return false;		}				$query = "INSERT INTO praise_wall (sns_type, author_sns_id, 			author, wall_title, message, picture, link, caption, description, date_created)			VALUES('$sns_type', '$author_sns_id', '$author', '$title',			'$message', '$picture', '$link', '$caption', 			'$description', NOW())"; 				$this->db->query($query);        return mysql_insert_id();	}		public function amen($feed_id, $current_user_id, $picture, $name)	{				$query = "SELECT user_amen_ids from praise_wall			WHERE id='$feed_id' LIMIT 1";					/*		$query = "UPDATE praise_wall SET amen_count=(amen_count+1),			user_amen_ids=(CASE when(user_amen_ids) then 			CONCAT(user_amen_ids, '$tmp') else			CONCAT(':', '$tmp') end) 			WHERE id='$feed_id'";		*/				$result = $this->db->query($query);		$result = $result->result_array();		if ($result[0]['user_amen_ids']) {			$new_amen_ids = $result[0]['user_amen_ids'].strval($current_user_id).':';			if($current_user_id != "") {				$query = "UPDATE praise_wall SET amen_count=(amen_count+1),					user_amen_ids='$new_amen_ids' WHERE id='$feed_id'";				}						}		else {			$new_amen_ids = ":".strval($current_user_id).":";			if($current_user_id != "") {				$query = "UPDATE praise_wall SET amen_count=(amen_count+1),					user_amen_ids='$new_amen_ids' WHERE id='$feed_id'";			}		}		$this->db->query($query);				/* add to praisewall amens */		$query = "INSERT INTO praisewall_amens(			sns_id, praisewall_id, picture, status, name) 			VALUES ('$current_user_id', '$feed_id', 			'$picture', 'AMENED', '$name')";        $this->db->query($query);        	}		public function get_amens($feed_id)	{		$query = "SELECT user_amen_ids FROM praise_wall WHERE id='$feed_id'";		$result = $this->db->query($query);		return $result->result_array(); 	}		public function get_likes($feed_id)	{		$query = "SELECT user_like_ids FROM praise_wall WHERE id='$feed_id'";		$result = $this->db->query($query);		return $result->result_array(); 	}		public function get_ameners($pw_id) 	{		$query = "SELECT name, picture from praisewall_amens where praisewall_id='$pw_id'";		$result = $this->db->query($query);		return $result->result_array();	}		public function is_amened($amens, $sns_id)	{		$tmp = ":$sns_id:";		if(strpos($amens, $tmp) !== false) {			return 1;		}		return 0;	}		public function is_liked($likes, $sns_id)	{		$tmp = ":$sns_id:";		if(strpos($likes, $tmp) !== false) {			return 1;		}		return 0;	}}